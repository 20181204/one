# 三次握手
![alt](https://frank-lam.github.io/fullstack-tutorial/pics/tcp-3.png)

 假设A为客户端B为服务器端
 
- 首先B处于LISTEN监听状态，等待客户的链接请求
- A向B发送链接请求报文段，SYN=1，ACK=0 选择一个初始号seq=x
- B收到链接请求的报文段，如果统一建立链接，则向A发送连接确认报文段，SYN=1 ACK=1确认号为X+1,同时也选择一个初始的序号seq=y
- A收到B的连接确认报文段后，还要向B发送确认，确认号为ack=y+1 序号为seq=x+1
- A的TCP通知上层应用进程，连接已经建立。
- B收到A的确认后，连接建立
- B的TCP收到主机A的确认后，也通知其上层应用进程，TCP连接已经建立。

为什么需要三次握手，两次不可以吗，为什么？
   
    为了防止已失效的连接请求报文突然又传送到服务端，占用服务器资源
    
    比如：客户端发送第一个连接请求没有丢失，而是在某个网络节点长时间滞留，以致延误到连接释放之后的某个时间才到服务器，本来
    这个是已经失效的报文，但是服务器收到次请求报文误以为发出的一个新的连接请求，于是就向A发出了确认报文，统一建立连接，由于
    客户端没有发出建立连接请求，因此不会理睬B的确认。也不会向B发送数据，浪费了很多服务器资源
    
### 四次挥手
![alt](https://frank-lam.github.io/fullstack-tutorial/pics/tcp-4.png)    

数据传输结束后，通信的双方都可释放连接，现在A的应用进程先向其TCP发送连接释放的请求报文，
并停止在发送数据，主动关闭TCP连接。

- A把连接释放报文段首部的FIN=1，其序号seq=u 等待B的确认
- B发出确认，确认号ack=u+1，而这个报文段自己的序号seq=v
- 从A到B这个方向的连接就释放了，TCP连接处于半关闭状态，A不能向B发送数据，B若发送数据A仍要接收
- 当B不再需要连接时，发送连接释放请求报文段，FIN=1
- A收到后发出确认，进入TIME-WAIT状态，等待2ms时间后释放连接
- B收到A的确认后释放连接
### 四次挥手原因

客户端发送了FIN连接释放报文后，服务器收到了这个报文，就会进入close-wait状态，这个状态是为了让服务器端发送还未传送
完毕的数据，传送完毕之后吗，服务器会发送fin连接释放报文

### TIME_WAIT
MSL最大生存时间，他是任务报文在网络上的最长时间，超过这个时间的报文将被丢弃

客户端收到服务器端的fin报文后进入次状态，此时并不是直接进入close状态，还需要等待一个时间计时器设置时间2msl
原因
- 确保最后一个报文段能够到达，如果B没有收到A发送来的确认报文段，那么就会重新发送连接释放请求报文段，A等待时间就是为了
处理这种情况
- 等待一段时间是为了让本连接持续时间内所有报文段都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文段。   

### 如何保证可靠传输

- 应用数据被分割为TCP认为合适的发送的数据块
- 超时重传 当TCP发出一个报文段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到，将重发这个报文段。
- TCP给发送的每个包进行编号，接收方对数据包进行排序，把有序数据传送到应用层
- 校验和，TCP将保持它首部和数据的检验和，这是一个端到端的检验和，目的是检测数据在传输过程中的任何变化，如果收到的段
的检验和有差错，TCP将丢弃这个报文段和不确认收到此报文段
- TCP的接收端会丢弃重复数据
- 流量控制：TCP连接的每一方都有固定大小的缓存空间，TCP的接收端值允许发送端发送接收端缓冲区能够接纳的数据，当接收端来不及
处理发送方的数据时候，能提示发送端降低发送的速率，防止包丢失，TCP使用的流量控制协议是可变大小的滑动窗口协议。
- 拥塞控制：当网络拥塞时，减少数据的发送

### HTTP请求报文和响应报文
请求报文
    
    GET /login   HTTP/1.1            请求行
    Host:localhost:8080              请求头
    Accept:image/gif                 请求头   
    Accept-Language:en-us            请求头
    Accept-Encoding:gzip             请求头
    User-Agent:Mozilla/4.0           请求头
    Content-Length:35                请求头
    
    username=123&email=1001@qq.com   请求正文
    
响应报文
   
   
    HTTP/1.1 200 OK                             状态行
    Content-Length: 744                         响应头
    Content-Type: text/plain; charset=UTF-8     响应头
    Date: Tue, 07 Jan 2020 06:41:50 GMT         响应头
    
    <h1>响应体</h1>
    
